# 导出功能修复说明

## 🐛 问题描述

点击"导出数据"按钮后，浏览器跳转到导出 URL，但页面空白，无法下载文件。

**错误现象**：
- URL: `localhost:5173/api/ai/admin/knowledge/export/excel`
- 页面显示空白
- 实际原因：401 未授权错误（缺少 Authorization token）

## 🔍 问题原因

原先的导出实现使用 `window.location.href` 直接跳转：

```typescript
// ❌ 错误的实现
export function exportToExcel(category?: string) {
  window.location.href = `/api/ai/admin/knowledge/export/excel?category=${category}`;
}
```

**问题**：
1. `window.location.href` 不会携带 HTTP 请求头
2. 后端需要 `Authorization: Bearer <token>` 进行鉴权
3. 缺少 token 导致 401 未授权错误
4. 浏览器无法处理错误响应，显示空白页面

## ✅ 解决方案

使用 axios 发送请求并下载文件：

### 1. 修改导出 API（knowledge.ts）

```typescript
// ✅ 正确的实现
export async function exportToExcel(category?: string) {
  const params: Record<string, string> = {};
  if (category) {
    params.category = category;
  }
  
  try {
    // 使用 axios 发送请求，自动携带 token
    const response = await request.get('/ai/admin/knowledge/export/excel', {
      params,
      responseType: 'blob',  // 关键：设置响应类型为 blob
      headers: {
        'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      }
    });
    
    // 创建下载链接
    const blob = new Blob([response as any], { 
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
    });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `知识库导出_${new Date().getTime()}.xlsx`;
    
    // 触发下载
    document.body.appendChild(link);
    link.click();
    
    // 清理
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error('导出 Excel 失败:', error);
    throw error;
  }
}
```

### 2. 修改 axios 响应拦截器（request.ts）

```typescript
this.instance.interceptors.response.use(
  (response) => {
    // ✅ 新增：如果是 blob 类型，直接返回
    if (response.config.responseType === 'blob') {
      return response.data;
    }
    
    // 原有逻辑
    const res = response.data;
    if (res.code !== 200) {
      throw new Error(res.msg || '请求失败');
    }
    return res.data;
  },
  // ... 错误处理
);
```

### 3. 修改页面调用（index.vue）

```typescript
// ✅ 改为 async 函数
const handleExport = async (key: string) => {
  try {
    if (key === 'excel') {
      message.loading('正在导出 Excel...', { duration: 0 });
      await exportToExcel(selectedCategory.value || undefined);
      message.destroyAll();
      message.success('导出成功！');
    } else if (key === 'csv') {
      message.loading('正在导出 CSV...', { duration: 0 });
      await exportToCSV(selectedCategory.value || undefined);
      message.destroyAll();
      message.success('导出成功！');
    }
  } catch (error: any) {
    message.destroyAll();
    message.error(error.message || '导出失败');
  }
};
```

## 🎯 修复后的流程

1. 用户点击"导出数据" → "导出为 Excel"
2. 前端调用 `exportToExcel()` 函数
3. axios 发送 GET 请求，携带 Authorization token
4. 后端验证 token，生成 Excel 文件
5. 返回 blob 数据
6. 前端创建临时下载链接
7. 触发浏览器下载
8. 清理临时对象

## ✨ 优势

1. ✅ **安全性**：自动携带 Authorization token
2. ✅ **用户体验**：不会跳转页面，直接下载
3. ✅ **错误处理**：可以捕获并提示错误信息
4. ✅ **加载提示**：显示"正在导出..."加载状态

## 📝 测试步骤

1. 刷新前端页面（Ctrl + Shift + R 强制刷新）
2. 点击"导出数据" → "导出为 Excel"
3. 应该看到：
   - 提示"正在导出 Excel..."
   - 文件自动下载
   - 提示"导出成功！"

## 🔧 调试方法

如果导出仍然失败，打开浏览器控制台（F12）检查：

1. **Network 标签**：
   - 查看请求是否发送
   - 检查响应状态码（应该是 200）
   - 查看请求头是否包含 Authorization

2. **Console 标签**：
   - 查看是否有 JavaScript 错误
   - 查看 console.error 输出

3. **后端日志**：
   - 检查后端是否收到请求
   - 检查是否有异常日志

## 📋 相关文件

修改的文件：
1. `fronted/web-admin/src/api/admin/knowledge.ts` - 导出函数
2. `fronted/web-admin/src/utils/request.ts` - axios 配置
3. `fronted/web-admin/src/views/KnowledgeQA/index.vue` - 页面调用

## ❓ 常见问题

### Q1: 点击导出后没有反应？
**A**: 检查浏览器控制台是否有错误，查看 Network 标签的请求状态。

### Q2: 下载的文件是空的？
**A**: 检查后端是否正确生成文件，查看响应的 Content-Type 是否正确。

### Q3: 提示"导出失败"？
**A**: 查看错误详细信息，可能是：
- 后端服务未启动
- Token 过期
- 数据库查询失败

---

**修复时间**: 2025-11-29  
**版本**: v1.1
