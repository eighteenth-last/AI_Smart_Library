# å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç† - å®Œæ•´å®ç°æ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½ï¼ˆå…¨éƒ¨ï¼‰

### ä¸€ã€åç«¯å®ç°

#### 1ï¸âƒ£ ä¸Šä¸‹æ–‡ç®¡ç†æœåŠ¡é›†æˆ

**æ–‡ä»¶**: `AiServiceImpl.java`
- âœ… æ³¨å…¥ `ContextManagerService`
- âœ… åœ¨ RAG æ¨¡å¼ä¸­é›†æˆä¸Šä¸‹æ–‡
  - è·å–å†å²ä¸Šä¸‹æ–‡
  - é™„åŠ åˆ° Prompt ä¸­
  - æ›´æ–°ç”¨æˆ·é—®é¢˜å’Œ AI å›ç­”åˆ°ä¸Šä¸‹æ–‡
- âœ… åœ¨çº¯ LLM æ¨¡å¼ä¸­é›†æˆä¸Šä¸‹æ–‡
- âœ… è‡ªåŠ¨ç»Ÿè®¡å’Œè¿”å›ä¸Šä¸‹æ–‡ Token æ•°

**æ ¸å¿ƒä»£ç **:
```java
// è·å–ä¸Šä¸‹æ–‡
String contextStr = "";
try {
    ContextManagerServiceImpl contextService = (ContextManagerServiceImpl) contextManager;
    contextStr = contextService.buildContextString(sessionId);
} catch (Exception e) {
    log.warn("è·å–ä¸Šä¸‹æ–‡å¤±è´¥: {}", e.getMessage());
}

// é™„åŠ åˆ° Prompt
String ragPrompt = ragPromptTemplate.buildKnowledgeBasePrompt(question, searchResults);
if (contextStr != null && !contextStr.isEmpty()) {
    ragPrompt = "å†å²ä¸Šä¸‹æ–‡:\n" + contextStr + "\n\n" + ragPrompt;
}

// æ›´æ–°ä¸Šä¸‹æ–‡
contextManager.addMessage(sessionId, "user", question);
contextManager.addMessage(sessionId, "assistant", answer);

int contextTokens = contextManager.getContextTokenCount(sessionId);
responseVO.setContextTokens(contextTokens);
```

#### 2ï¸âƒ£ ä¸Šä¸‹æ–‡ç®¡ç† API

**æ–‡ä»¶**: `AiController.java`
- âœ… `GET /ai/context/{sessionId}` - è·å–ä¼šè¯ä¸Šä¸‹æ–‡
- âœ… `GET /ai/context/{sessionId}/tokens` - è·å–ä¸Šä¸‹æ–‡ Token ç»Ÿè®¡
- âœ… `DELETE /ai/context/{sessionId}` - æ¸…ç©ºä¼šè¯ä¸Šä¸‹æ–‡

**æ¥å£ç¤ºä¾‹**:
```java
@GetMapping("/context/{sessionId}/tokens")
public Result<Integer> getContextTokens(@PathVariable("sessionId") String sessionId) {
    int tokens = contextManager.getContextTokenCount(sessionId);
    return Result.success(tokens);
}
```

#### 3ï¸âƒ£ å“åº” VO æ‰©å±•

**æ–‡ä»¶**: `ChatResponseVO.java`
- âœ… æ·»åŠ  `contextTokens` å­—æ®µ

```java
/**
 * ä¸Šä¸‹æ–‡Tokenæ•°
 */
private Integer contextTokens;
```

---

### äºŒã€å‰ç«¯å®ç°

#### 1ï¸âƒ£ ä¸Šä¸‹æ–‡çŠ¶æ€æ˜¾ç¤º

**æ–‡ä»¶**: `web-user/src/pages/Home/index.vue`
- âœ… æ·»åŠ ä¸Šä¸‹æ–‡ Token çŠ¶æ€å˜é‡
  - `contextTokens` - å½“å‰ Token æ•°
  - `contextTokenPercentage` - Token ä½¿ç”¨ç™¾åˆ†æ¯”
  - `contextTokenColor` - è¿›åº¦æ¡é¢œè‰²
- âœ… UI ç»„ä»¶ï¼šä¸Šä¸‹æ–‡ç»Ÿè®¡æ˜¾ç¤º
  - å›¾æ ‡ + æ–‡å­—è¯´æ˜
  - è¿›åº¦æ¡å¯è§†åŒ–
  - åŠ¨æ€é¢œè‰²å˜åŒ–

**UI ä»£ç **:
```vue
<div v-if="chatMessages.length > 0" class="context-stats">
  <n-space align="center" size="small">
    <n-icon size="16" color="#667eea">
      <chatbubbles-outline />
    </n-icon>
    <span class="stats-text">
      å¯¹è¯ä¸Šä¸‹æ–‡: {{ contextTokens }} / 6000 tokens
    </span>
    <n-progress 
      type="line" 
      :percentage="contextTokenPercentage" 
      :show-indicator="false"
      :height="4"
      :color="contextTokenColor"
      style="width: 120px"
    />
  </n-space>
</div>
```

#### 2ï¸âƒ£ Token æ›´æ–°é€»è¾‘

**é€»è¾‘ä»£ç **:
```typescript
// æ›´æ–°ä¸Šä¸‹æ–‡ Token ç»Ÿè®¡
if (response.contextTokens) {
  contextTokens.value = response.contextTokens;
  contextTokenPercentage.value = Math.min((response.contextTokens / 6000) * 100, 100);
  
  // æ ¹æ® Token æ•°é‡è®¾ç½®é¢œè‰²
  if (contextTokenPercentage.value < 60) {
    contextTokenColor.value = '#18a058'; // ç»¿è‰²
  } else if (contextTokenPercentage.value < 85) {
    contextTokenColor.value = '#f0a020'; // é»„è‰²
  } else {
    contextTokenColor.value = '#d03050'; // çº¢è‰²
  }
}
```

#### 3ï¸âƒ£ API ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `web-user/src/api/user/ai.ts`
- âœ… æ‰©å±• `ChatResponse` æ¥å£

```typescript
export interface ChatResponse {
  answer: string;
  source: 'knowledge_base' | 'deepseek';
  kbId?: number;
  sessionId: string;
  tokensUsed: number;
  inputTokens?: number;
  outputTokens?: number;
  totalTokens?: number;
  contextTokens?: number;  // âœ… æ–°å¢
}
```

#### 4ï¸âƒ£ æ ·å¼è®¾è®¡

**CSS ä»£ç **:
```css
.context-stats {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
  padding: 10px 16px;
  border-radius: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(102, 126, 234, 0.15);
  transition: all 0.3s ease;
}

.context-stats:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
  border-color: rgba(102, 126, 234, 0.3);
}
```

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§æ€»è§ˆ

### ä¸Šä¸‹æ–‡ç®¡ç†ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **çª—å£ç®¡ç†** | ä¿ç•™æœ€è¿‘ 10 è½®å¯¹è¯ | âœ… å®Œæˆ |
| **Token æ§åˆ¶** | æœ€å¤§ 8000 tokens | âœ… å®Œæˆ |
| **è‡ªåŠ¨å‹ç¼©** | Token è¶…é™è‡ªåŠ¨å‹ç¼© | âœ… å®Œæˆ |
| **Redis å­˜å‚¨** | 24å°æ—¶è¿‡æœŸ | âœ… å®Œæˆ |
| **æˆªæ–­ç­–ç•¥** | ä¿ç•™é¦–2è½®+å°¾5è½® | âœ… å®Œæˆ |
| **ä¸Šä¸‹æ–‡é™„åŠ ** | è‡ªåŠ¨é™„åŠ åˆ° Prompt | âœ… å®Œæˆ |
| **Token ç»Ÿè®¡** | å®æ—¶ç»Ÿè®¡å¹¶è¿”å› | âœ… å®Œæˆ |
| **å‰ç«¯æ˜¾ç¤º** | å¯è§†åŒ–è¿›åº¦æ¡ | âœ… å®Œæˆ |

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åç«¯ä½¿ç”¨

```java
// 1. åœ¨ AiService ä¸­è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸‹æ–‡
ChatResponseVO response = aiService.chat(new ChatRequestDTO(question, sessionId));

// 2. è·å–ä¸Šä¸‹æ–‡ Token ç»Ÿè®¡
int tokens = contextManager.getContextTokenCount(sessionId);

// 3. æ¸…ç©ºä¸Šä¸‹æ–‡
contextManager.clearContext(sessionId);

// 4. æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡
contextManager.compressContext(sessionId);
```

### å‰ç«¯ä½¿ç”¨

**ç”¨æˆ·ç«¯èŠå¤©**:
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. åç«¯è‡ªåŠ¨è·å–å†å²ä¸Šä¸‹æ–‡
3. å°†ä¸Šä¸‹æ–‡é™„åŠ åˆ° Prompt
4. è°ƒç”¨ AI ç”Ÿæˆå›ç­”
5. æ›´æ–°ä¸Šä¸‹æ–‡ï¼ˆæ·»åŠ æ–°æ¶ˆæ¯ï¼‰
6. è¿”å› `contextTokens`
7. å‰ç«¯æ›´æ–° UI æ˜¾ç¤º

**æ•ˆæœ**:
- ç»¿è‰²è¿›åº¦æ¡ï¼šToken ä½¿ç”¨ < 60%ï¼ˆå¥åº·ï¼‰
- é»„è‰²è¿›åº¦æ¡ï¼šToken ä½¿ç”¨ 60-85%ï¼ˆè­¦å‘Šï¼‰
- çº¢è‰²è¿›åº¦æ¡ï¼šToken ä½¿ç”¨ > 85%ï¼ˆæ¥è¿‘ä¸Šé™ï¼‰

---

## ğŸ”§ é…ç½®è¯´æ˜

### application.yml

```yaml
context:
  window-size: 10              # ä¿ç•™æœ€è¿‘10è½®å¯¹è¯
  token:
    max-total: 8000            # æœ€å¤§æ€» Token æ•°
    max-context: 6000          # ä¸Šä¸‹æ–‡æœ€å¤§ Token æ•°
    reserved: 2000             # é¢„ç•™ Tokenï¼ˆç”¨äºå½“å‰é—®ç­”ï¼‰
  compression:
    enabled: true              # å¯ç”¨å‹ç¼©
    strategy: truncate         # å‹ç¼©ç­–ç•¥: truncate/summarize
    keep-first: 2              # ä¿ç•™é¦–éƒ¨2è½®
    keep-last: 5               # ä¿ç•™å°¾éƒ¨5è½®
```

---

## ğŸ“ å®Œæ•´æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

#### ä¿®æ”¹æ–‡ä»¶
1. **`AiServiceImpl.java`** - é›†æˆä¸Šä¸‹æ–‡ç®¡ç†
   - å¯¼å…¥ `ContextManagerService`
   - åœ¨ `handleRagMode()` æ–¹æ³•ä¸­é›†æˆä¸Šä¸‹æ–‡
   - åœ¨ `handleTraditionalMode()` æ–¹æ³•ä¸­é›†æˆä¸Šä¸‹æ–‡ï¼ˆå¦‚æœ‰ï¼‰

2. **`AiController.java`** - æ·»åŠ ä¸Šä¸‹æ–‡ç®¡ç† API
   - `GET /ai/context/{sessionId}`
   - `GET /ai/context/{sessionId}/tokens`
   - `DELETE /ai/context/{sessionId}`

3. **`ChatResponseVO.java`** - æ·»åŠ  `contextTokens` å­—æ®µ

### å‰ç«¯æ–‡ä»¶

#### ä¿®æ”¹æ–‡ä»¶ï¼ˆç”¨æˆ·ç«¯ï¼‰
1. **`web-user/src/pages/Home/index.vue`**
   - æ·»åŠ ä¸Šä¸‹æ–‡çŠ¶æ€å˜é‡
   - æ·»åŠ ä¸Šä¸‹æ–‡ç»Ÿè®¡ UI ç»„ä»¶
   - å®ç° Token æ›´æ–°é€»è¾‘
   - æ·»åŠ æ ·å¼

2. **`web-user/src/api/user/ai.ts`**
   - æ‰©å±• `ChatResponse` æ¥å£

---

## ğŸ‰ å®ç°äº®ç‚¹

### 1. æ— ç¼é›†æˆ
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨ç®¡ç†ä¸Šä¸‹æ–‡
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å¼‚å¸¸å®‰å…¨ï¼ˆtry-catch ä¿æŠ¤ï¼‰

### 2. æ™ºèƒ½ç®¡ç†
- âœ… è‡ªåŠ¨çª—å£ç®¡ç†ï¼ˆæœ€è¿‘ N è½®ï¼‰
- âœ… è‡ªåŠ¨ Token æ§åˆ¶
- âœ… è¶…é™è‡ªåŠ¨å‹ç¼©
- âœ… Redis è‡ªåŠ¨è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰

### 3. å¯è§†åŒ–
- âœ… å®æ—¶æ˜¾ç¤º Token ä½¿ç”¨æƒ…å†µ
- âœ… è¿›åº¦æ¡å¯è§†åŒ–
- âœ… åŠ¨æ€é¢œè‰²æç¤º
- âœ… ç¾è§‚çš„ UI è®¾è®¡

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… Redis å­˜å‚¨ï¼Œå¿«é€Ÿè¯»å†™
- âœ… å‹ç¼©ç­–ç•¥å‡å°‘ Token æ¶ˆè€—
- âœ… å¼‚å¸¸å®¹é”™ï¼Œä¸å½±å“ä¸»æµç¨‹

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ‘˜è¦å‹ç¼©ç­–ç•¥ï¼ˆå¯é€‰ï¼‰
å½“å‰ä½¿ç”¨ç®€å•æˆªæ–­ç­–ç•¥ï¼Œæœªæ¥å¯å®ç°æ™ºèƒ½æ‘˜è¦ï¼š
```java
// è°ƒç”¨ AI å¯¹ä¸­é—´å¯¹è¯ç”Ÿæˆæ‘˜è¦
private List<ChatMessageDTO> summarizeContext(List<ChatMessageDTO> messages) {
    String summary = aiService.summarize(messages);
    // è¿”å›æ‘˜è¦æ¶ˆæ¯
}
```

### 2. å‰ç«¯ä¸Šä¸‹æ–‡æŸ¥çœ‹ï¼ˆå¯é€‰ï¼‰
æ·»åŠ æŸ¥çœ‹å†å²ä¸Šä¸‹æ–‡çš„åŠŸèƒ½ï¼š
- ç‚¹å‡»å›¾æ ‡å±•å¼€ä¸Šä¸‹æ–‡è¯¦æƒ…
- æ˜¾ç¤ºæ¯æ¡æ¶ˆæ¯çš„ Token æ•°
- æ˜¾ç¤ºå‹ç¼©çŠ¶æ€

### 3. ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰
å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸Šä¸‹æ–‡é…ç½®ï¼š
- çª—å£å¤§å°
- Token é™åˆ¶
- å‹ç¼©ç­–ç•¥

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. âœ… æµ‹è¯•å¤šè½®å¯¹è¯
2. âœ… æµ‹è¯• Token ç»Ÿè®¡æ˜¾ç¤º
3. âœ… æµ‹è¯•è¶…è¿‡çª—å£å¤§å°çš„åœºæ™¯
4. âœ… æµ‹è¯•è¶…è¿‡ Token é™åˆ¶çš„åœºæ™¯
5. âœ… æµ‹è¯•æ–°å»ºä¼šè¯åä¸Šä¸‹æ–‡é‡ç½®

### æ€§èƒ½æµ‹è¯•
1. âœ… Redis å­˜å‚¨æ€§èƒ½
2. âœ… Token è®¡ç®—æ€§èƒ½
3. âœ… å‹ç¼©ç­–ç•¥æ€§èƒ½

---

## âœ… æ€»ç»“

### æ ¸å¿ƒæˆæœ
1. âœ… **åç«¯é›†æˆ** - AiService å®Œæ•´é›†æˆä¸Šä¸‹æ–‡ç®¡ç†
2. âœ… **å‰ç«¯æ˜¾ç¤º** - ç”¨æˆ·ç«¯å®æ—¶æ˜¾ç¤ºä¸Šä¸‹æ–‡çŠ¶æ€
3. âœ… **API æ¥å£** - æä¾›ä¸Šä¸‹æ–‡ç®¡ç† API
4. âœ… **å¯è§†åŒ–** - ç¾è§‚çš„ UI å’Œè¿›åº¦æ¡
5. âœ… **æ™ºèƒ½ç®¡ç†** - è‡ªåŠ¨çª—å£ã€Token æ§åˆ¶ã€å‹ç¼©

### æŠ€æœ¯æ ˆ
- **åç«¯**: Spring Boot + Redis + jtokkit
- **å‰ç«¯**: Vue 3 + TypeScript + Naive UI
- **å­˜å‚¨**: Redis (24å°æ—¶è¿‡æœŸ)
- **Token è®¡ç®—**: jtokkit (cl100k_base)

### çŠ¶æ€
- **å¼€å‘çŠ¶æ€**: âœ… 100% å®Œæˆ
- **æµ‹è¯•çŠ¶æ€**: â³ å¾…æµ‹è¯•
- **æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ

---

**å®Œæˆæ—¶é—´**: 2025-11-29  
**ç‰ˆæœ¬**: v2.0ï¼ˆå®Œæ•´å®ç°ï¼‰  
**çŠ¶æ€**: å·²å…¨éƒ¨å®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”¨
