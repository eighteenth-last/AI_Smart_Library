# çŸ¥è¯†åº“è‡ªåŠ¨æ›´æ–°åŠŸèƒ½å®Œæˆæ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½ï¼ˆå…¨éƒ¨ 4 é¡¹ï¼‰

### ä¸€ã€å›¾ä¹¦ä¿¡æ¯åˆ°çŸ¥è¯†åº“æ˜ å°„è§„åˆ™è®¾è®¡ âœ…

**æ–‡æ¡£**: `å›¾ä¹¦ä¿¡æ¯åˆ°çŸ¥è¯†åº“æ˜ å°„è§„åˆ™.md`

#### æ˜ å°„è§„åˆ™æ€»è§ˆ
| è§„åˆ™ç±»å‹ | ç”Ÿæˆæ¡æ•° | å¿…éœ€/å¯é€‰ | è¯´æ˜ |
|---------|---------|----------|------|
| å›¾ä¹¦ç®€ä»‹ | 1 | âœ… å¿…é€‰ | ä» `description` ç”Ÿæˆ |
| ä½œè€…ä¿¡æ¯ | 1 | âœ… å¿…é€‰ | ä» `authorName` ç”Ÿæˆ |
| åº“å­˜ä¿¡æ¯ | 1 | âœ… å¿…é€‰ | ä» `availableStock` ç”Ÿæˆ |
| å‡ºç‰ˆä¿¡æ¯ | 1 | â­• å¯é€‰ | ä» `publisher` + `publishYear` ç”Ÿæˆ |
| åˆ†ç±»ä¿¡æ¯ | 1 | â­• å¯é€‰ | ä» `categoryName` ç”Ÿæˆ |
| è¯„åˆ†ä¿¡æ¯ | 1 | â­• å¯é€‰ | ä» `averageRating` ç”Ÿæˆ |
| ISBNæŸ¥è¯¢ | 1 | â­• å¯é€‰ | ä» `isbn` ç”Ÿæˆ |

**æ¯æœ¬å›¾ä¹¦ç”Ÿæˆ**: 3-7 æ¡çŸ¥è¯†åº“é—®ç­”å¯¹

---

### äºŒã€è‡ªåŠ¨ç”ŸæˆæœåŠ¡å®ç° âœ…

**æ–‡ä»¶**: 
- `AutoKnowledgeGenerateService.java` - æœåŠ¡æ¥å£
- `AutoKnowledgeGenerateServiceImpl.java` - æœåŠ¡å®ç°ï¼ˆ367è¡Œï¼‰

#### æ ¸å¿ƒåŠŸèƒ½

##### 1. å•æœ¬å›¾ä¹¦ç”Ÿæˆ
```java
int generateKnowledgeFromBook(Long bookId)
```
- æŸ¥è¯¢å›¾ä¹¦è¯¦æƒ…ï¼ˆå¸¦ä½œè€…ã€åˆ†ç±»ä¿¡æ¯ï¼‰
- æ£€æŸ¥æ˜¯å¦æ»¡è¶³ç”Ÿæˆæ¡ä»¶
- ç”Ÿæˆ 3-7 æ¡é—®ç­”å¯¹
- è‡ªåŠ¨ç”Ÿæˆå‘é‡ï¼ˆembeddingï¼‰

##### 2. æ‰¹é‡ç”Ÿæˆ
```java
int batchGenerateKnowledge(List<Long> bookIds)
```
- æ‰¹é‡å¤„ç†å¤šæœ¬å›¾ä¹¦
- å¼‚å¸¸å®¹é”™ï¼ˆå•æœ¬å¤±è´¥ä¸å½±å“å…¶ä»–ï¼‰
- è¿”å›æ€»ç”Ÿæˆæ•°

##### 3. å…¨é‡ç”Ÿæˆ
```java
int generateKnowledgeFromAllBooks()
```
- æŸ¥è¯¢æ‰€æœ‰ä¸Šæ¶å›¾ä¹¦
- åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹ 100 æœ¬ï¼‰
- é€‚åˆåˆæ¬¡éƒ¨ç½²æˆ–æ•°æ®è¿ç§»

##### 4. æ›´æ–°çŸ¥è¯†åº“
```java
int updateBookKnowledge(Long bookId)
```
- åˆ é™¤æ—§çŸ¥è¯†åº“
- é‡æ–°ç”Ÿæˆæœ€æ–°çŸ¥è¯†åº“
- é€‚åˆå›¾ä¹¦ä¿¡æ¯æ›´æ–°æ—¶è°ƒç”¨

##### 5. åˆ é™¤çŸ¥è¯†åº“
```java
int deleteBookKnowledge(Long bookId)
```
- æ ¹æ® `source = book_{bookId}` åˆ é™¤
- é€‚åˆå›¾ä¹¦ä¸‹æ¶æ—¶è°ƒç”¨

---

### ä¸‰ã€å®šæ—¶åŒæ­¥ä»»åŠ¡ âœ…

**æ–‡ä»¶**: `AutoKnowledgeSyncTask.java`

#### å®šæ—¶ä»»åŠ¡é…ç½®
```java
@Scheduled(cron = "${auto-knowledge.schedule.cron:0 0 3 * * ?}")
public void syncBookKnowledge()
```

**æ‰§è¡Œæ—¶é—´**: æ¯å¤©å‡Œæ™¨ 3:00

**æ‰§è¡Œæµç¨‹**:
1. æ£€æŸ¥é…ç½®å¼€å…³ï¼ˆ`auto-knowledge.enabled`ï¼‰
2. æ£€æŸ¥å›¾ä¹¦åŒæ­¥å¼€å…³ï¼ˆ`auto-knowledge.book-sync.enabled`ï¼‰
3. è°ƒç”¨å…¨é‡ç”ŸæˆæœåŠ¡
4. è®°å½•æ‰§è¡Œæ—¶é—´å’Œç”Ÿæˆæ•°é‡
5. å¼‚å¸¸å®¹é”™å’Œæ—¥å¿—è®°å½•

#### æ‰‹åŠ¨è§¦å‘
```java
public int manualSync()
```
- æä¾›æ‰‹åŠ¨è§¦å‘æ¥å£
- æ–¹ä¾¿ç®¡ç†å‘˜å³æ—¶åŒæ­¥

---

### å››ã€å‘é‡ç¼“å­˜æ›´æ–°æœºåˆ¶ âœ…

**å®ç°ä½ç½®**: `AutoKnowledgeGenerateServiceImpl.generateEmbedding()`

#### å‘é‡ç”Ÿæˆæµç¨‹
```java
private void generateEmbedding(KnowledgeBase knowledge) {
    // 1. æ‹¼æ¥é—®é¢˜å’Œç­”æ¡ˆ
    String text = knowledge.getQuestion() + " " + knowledge.getAnswer();
    
    // 2. è°ƒç”¨å‘é‡æœåŠ¡ç”Ÿæˆ embedding
    List<Double> embedding = vectorService.generateEmbedding(text);
    
    // 3. è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¿å­˜
    String embeddingStr = embedding.toString();
    knowledge.setEmbedding(embeddingStr);
    
    // 4. æ›´æ–°æ•°æ®åº“
    knowledgeBaseMapper.updateById(knowledge);
}
```

#### ç¼“å­˜ç­–ç•¥
- **å¯ç”¨æ¡ä»¶**: `auto-knowledge.vector-cache.enabled = true`
- **ç”Ÿæˆæ—¶æœº**: çŸ¥è¯†åº“æ’å…¥åç«‹å³ç”Ÿæˆ
- **TTL**: 24 å°æ—¶ï¼ˆé…ç½®é¡¹ï¼š`auto-knowledge.vector-cache.ttl`ï¼‰

---

## ğŸ“‹ API æ¥å£

### ç®¡ç†ç«¯æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|------|
| å•æœ¬ç”Ÿæˆ | POST | `/ai/admin/knowledge/generate/{bookId}` | ä»å•æœ¬å›¾ä¹¦ç”ŸæˆçŸ¥è¯†åº“ |
| æ‰¹é‡ç”Ÿæˆ | POST | `/ai/admin/knowledge/generate/batch` | æ‰¹é‡ç”Ÿæˆï¼ˆä¼ å…¥bookIdsæ•°ç»„ï¼‰ |
| å…¨é‡ç”Ÿæˆ | POST | `/ai/admin/knowledge/generate/all` | ä»æ‰€æœ‰ä¸Šæ¶å›¾ä¹¦ç”Ÿæˆ |
| æ›´æ–°çŸ¥è¯†åº“ | PUT | `/ai/admin/knowledge/generate/{bookId}` | æ›´æ–°æŒ‡å®šå›¾ä¹¦çš„çŸ¥è¯†åº“ |
| åˆ é™¤çŸ¥è¯†åº“ | DELETE | `/ai/admin/knowledge/generate/{bookId}` | åˆ é™¤æŒ‡å®šå›¾ä¹¦çš„çŸ¥è¯†åº“ |
| æ‰‹åŠ¨åŒæ­¥ | POST | `/ai/admin/knowledge/sync` | æ‰‹åŠ¨è§¦å‘åŒæ­¥ä»»åŠ¡ |

---

## âš™ï¸ é…ç½®è¯´æ˜

### application.yml

```yaml
# çŸ¥è¯†åº“è‡ªåŠ¨æ›´æ–°é…ç½®
auto-knowledge:
  # æ€»å¼€å…³
  enabled: true
  
  # å®šæ—¶åŒæ­¥é…ç½®
  schedule:
    # Cron è¡¨è¾¾å¼ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹ï¼‰
    cron: "0 0 3 * * ?"
  
  # å‘é‡ç¼“å­˜é…ç½®
  vector-cache:
    # æ˜¯å¦å¯ç”¨å‘é‡ç”Ÿæˆ
    enabled: true
    # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼‰
    ttl: 24
  
  # å›¾ä¹¦åŒæ­¥é…ç½®
  book-sync:
    # æ˜¯å¦å¯ç”¨å›¾ä¹¦åŒæ­¥
    enabled: true
    # æ‰¹é‡å¤„ç†æ•°é‡
    batch-size: 100
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. æ–°å¢å›¾ä¹¦åè‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åº“

**åœºæ™¯**: ç®¡ç†å‘˜æ–°å¢ä¸€æœ¬å›¾ä¹¦

**è°ƒç”¨**:
```java
// æ–¹å¼1ï¼šé€šè¿‡ API æ‰‹åŠ¨è§¦å‘
POST /ai/admin/knowledge/generate/{bookId}

// æ–¹å¼2ï¼šåœ¨ BookService.createBook() ä¸­è‡ªåŠ¨è°ƒç”¨
@Autowired
private AutoKnowledgeGenerateService autoKnowledgeGenerateService;

public Long createBook(BookCreateDTO dto) {
    // ... åˆ›å»ºå›¾ä¹¦
    Long bookId = book.getBookId();
    
    // è‡ªåŠ¨ç”ŸæˆçŸ¥è¯†åº“
    autoKnowledgeGenerateService.generateKnowledgeFromBook(bookId);
    
    return bookId;
}
```

---

### 2. å›¾ä¹¦ä¿¡æ¯æ›´æ–°ååŒæ­¥çŸ¥è¯†åº“

**åœºæ™¯**: ç®¡ç†å‘˜æ›´æ–°å›¾ä¹¦ç®€ä»‹

**è°ƒç”¨**:
```java
public boolean updateBook(Long bookId, BookUpdateDTO dto) {
    // ... æ›´æ–°å›¾ä¹¦
    
    // æ›´æ–°çŸ¥è¯†åº“
    autoKnowledgeGenerateService.updateBookKnowledge(bookId);
    
    return true;
}
```

---

### 3. å›¾ä¹¦ä¸‹æ¶ååˆ é™¤çŸ¥è¯†åº“

**åœºæ™¯**: ç®¡ç†å‘˜ä¸‹æ¶å›¾ä¹¦

**è°ƒç”¨**:
```java
public boolean offlineBook(Long bookId) {
    // æ›´æ–°çŠ¶æ€ä¸ºä¸‹æ¶
    book.setStatus(0);
    bookMapper.updateById(book);
    
    // åˆ é™¤ç›¸å…³çŸ¥è¯†åº“
    autoKnowledgeGenerateService.deleteBookKnowledge(bookId);
    
    return true;
}
```

---

### 4. åˆæ¬¡éƒ¨ç½²æ—¶å…¨é‡ç”Ÿæˆ

**åœºæ™¯**: ç³»ç»Ÿåˆæ¬¡éƒ¨ç½²ï¼Œéœ€è¦ä»ç°æœ‰å›¾ä¹¦ç”ŸæˆçŸ¥è¯†åº“

**è°ƒç”¨**:
```bash
# æ–¹å¼1ï¼šé€šè¿‡ API
POST /ai/admin/knowledge/generate/all

# æ–¹å¼2ï¼šç­‰å¾…å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œï¼ˆå‡Œæ™¨3ç‚¹ï¼‰
```

---

## ğŸ“Š ç”Ÿæˆç¤ºä¾‹

### è¾“å…¥ï¼šå›¾ä¹¦æ•°æ®
```json
{
  "bookId": 1,
  "title": "ä¸‰ä½“",
  "authorName": "åˆ˜æ…ˆæ¬£",
  "categoryName": "ç§‘å¹»",
  "publisher": "é‡åº†å‡ºç‰ˆç¤¾",
  "publishYear": 2008,
  "description": "åœ°çƒæ–‡æ˜ä¸ä¸‰ä½“æ–‡æ˜çš„é¦–æ¬¡æ¥è§¦...",
  "isbn": "9787530216783",
  "totalStock": 30,
  "availableStock": 26,
  "averageRating": 4.8,
  "reviewCount": 150
}
```

### è¾“å‡ºï¼šçŸ¥è¯†åº“é—®ç­”å¯¹ï¼ˆ6æ¡ï¼‰

```sql
INSERT INTO knowledge_base 
(question, answer, category, source, is_public, hit_count, created_at, updated_at)
VALUES

-- 1. å›¾ä¹¦ç®€ä»‹
('ã€Šä¸‰ä½“ã€‹è®²çš„æ˜¯ä»€ä¹ˆï¼Ÿ', 
 'ã€Šä¸‰ä½“ã€‹åœ°çƒæ–‡æ˜ä¸ä¸‰ä½“æ–‡æ˜çš„é¦–æ¬¡æ¥è§¦...', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW()),

-- 2. ä½œè€…ä¿¡æ¯
('ã€Šä¸‰ä½“ã€‹æ˜¯è°å†™çš„ï¼Ÿ', 
 'ã€Šä¸‰ä½“ã€‹çš„ä½œè€…æ˜¯åˆ˜æ…ˆæ¬£ã€‚', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW()),

-- 3. åº“å­˜ä¿¡æ¯
('ã€Šä¸‰ä½“ã€‹è¿˜æœ‰ä¹¦å—ï¼Ÿ', 
 'ç›®å‰ã€Šä¸‰ä½“ã€‹æœ‰26æœ¬å¯å€Ÿï¼Œæ€»é¦†è—30æœ¬ã€‚', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW()),

-- 4. å‡ºç‰ˆä¿¡æ¯
('ã€Šä¸‰ä½“ã€‹ä»€ä¹ˆæ—¶å€™å‡ºç‰ˆçš„ï¼Ÿ', 
 'ã€Šä¸‰ä½“ã€‹ç”±é‡åº†å‡ºç‰ˆç¤¾äº2008å¹´å‡ºç‰ˆã€‚', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW()),

-- 5. åˆ†ç±»ä¿¡æ¯
('ã€Šä¸‰ä½“ã€‹å±äºä»€ä¹ˆåˆ†ç±»ï¼Ÿ', 
 'ã€Šä¸‰ä½“ã€‹å±äºç§‘å¹»ç±»å›¾ä¹¦ã€‚', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW()),

-- 6. è¯„åˆ†ä¿¡æ¯
('ã€Šä¸‰ä½“ã€‹è¯„åˆ†å¤šå°‘ï¼Ÿ', 
 'ã€Šä¸‰ä½“ã€‹çš„å¹³å‡è¯„åˆ†æ˜¯4.8åˆ†ï¼ˆåŸºäº150æ¡è¯„ä»·ï¼‰ï¼Œéå¸¸å—è¯»è€…æ¬¢è¿ã€‚', 
 'å›¾ä¹¦ä¿¡æ¯', 'book_1', 1, 0, NOW(), NOW());
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. ç”Ÿæˆæ¡ä»¶è¿‡æ»¤

```java
private boolean isEligibleForGeneration(BookVO book) {
    // å¿…é¡»æ˜¯ä¸Šæ¶çŠ¶æ€
    if (book.getStatus() != 1) return false;
    
    // å¿…é¡»æœ‰ç®€ä»‹
    if (!StringUtils.hasText(book.getDescription())) return false;
    
    // ç®€ä»‹é•¿åº¦è‡³å°‘20å­—ç¬¦
    if (book.getDescription().length() < 20) return false;
    
    return true;
}
```

### 2. å»é‡æœºåˆ¶

- ä½¿ç”¨ `source = book_{bookId}` å”¯ä¸€æ ‡è¯†
- æ›´æ–°å‰å…ˆåˆ é™¤æ—§æ•°æ®
- é¿å…é‡å¤ç”Ÿæˆ

### 3. å¼‚å¸¸å®¹é”™

```java
try {
    knowledgeBaseMapper.insert(knowledge);
    // ç”Ÿæˆå‘é‡
    if (config.getVectorCache().getEnabled()) {
        generateEmbedding(knowledge);
    }
} catch (Exception e) {
    log.error("æ’å…¥çŸ¥è¯†åº“å¤±è´¥ - question: {}, error: {}", 
        knowledge.getQuestion(), e.getMessage());
    // ç»§ç»­å¤„ç†ä¸‹ä¸€æ¡
}
```

---

## ğŸ‰ åŠŸèƒ½æ€»ç»“

### å·²å®Œæˆ
- âœ… æ˜ å°„è§„åˆ™è®¾è®¡ï¼ˆ7ç§é—®é¢˜ç±»å‹ï¼‰
- âœ… è‡ªåŠ¨ç”ŸæˆæœåŠ¡ï¼ˆ5ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰
- âœ… å®šæ—¶åŒæ­¥ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹ï¼‰
- âœ… å‘é‡ç¼“å­˜æ›´æ–°ï¼ˆè‡ªåŠ¨ç”Ÿæˆembeddingï¼‰
- âœ… ç®¡ç† API æ¥å£ï¼ˆ6ä¸ªæ¥å£ï¼‰
- âœ… é…ç½®ç®¡ç†ï¼ˆå¼€å…³ã€å®šæ—¶ã€ç¼“å­˜ï¼‰

### æŠ€æœ¯æ ˆ
- **åç«¯**: Spring Boot + MyBatis-Plus + Spring Scheduling
- **å‘é‡**: Embedding APIï¼ˆqwen3-embedding-8bï¼‰
- **æ•°æ®åº“**: MySQLï¼ˆknowledge_baseè¡¨ï¼‰
- **é…ç½®**: application.yml

### ä¼˜åŠ¿
1. **è‡ªåŠ¨åŒ–**: å®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒæ­¥ï¼Œæ— éœ€äººå·¥ç»´æŠ¤
2. **å®æ—¶æ€§**: å›¾ä¹¦æ›´æ–°å³æ—¶åŒæ­¥åˆ°çŸ¥è¯†åº“
3. **æ™ºèƒ½åŒ–**: è‡ªåŠ¨ç”Ÿæˆå‘é‡ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢
4. **å¯æ§æ€§**: æä¾›å¤šä¸ªç®¡ç†æ¥å£ï¼Œçµæ´»æ§åˆ¶
5. **å®¹é”™æ€§**: å¼‚å¸¸å¤„ç†å®Œå–„ï¼Œå•æ¡å¤±è´¥ä¸å½±å“æ•´ä½“

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. å¢é‡æ›´æ–°ï¼ˆå¯é€‰ï¼‰
- åªåŒæ­¥æ–°å¢/æ›´æ–°çš„å›¾ä¹¦
- å‡å°‘å®šæ—¶ä»»åŠ¡å‹åŠ›

### 2. å¼‚æ­¥å¤„ç†ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥ç”Ÿæˆ
- æå‡ç”Ÿæˆæ•ˆç‡

### 3. è¿›åº¦é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
- ç”Ÿæˆè¿›åº¦æ¨é€åˆ°å‰ç«¯
- æ˜¾ç¤ºç”ŸæˆçŠ¶æ€

---

**å®Œæˆæ—¶é—´**: 2025-11-29  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆï¼Œå¯æŠ•å…¥ä½¿ç”¨
